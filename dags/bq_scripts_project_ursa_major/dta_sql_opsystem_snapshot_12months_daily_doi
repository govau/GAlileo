/*
BigQuery SQL Script
Script to output device operating system to interact with agency's websites - Daily Run
*/

/* Schedule: Daily run for full snapshot of agencies' dataset */

BEGIN
    create temp table t_12months_snapshot_opsys_monthlydelta_doi
    as
       select 
        t.device_opsys,
        t.month_year,
        t.opsys_count,
        round((t.opsys_count / (sum(t.opsys_count) over (partition by t.visit_year, t.visit_month order by t.visit_year, t.visit_month)) * 100),2) as percent_month,
        dense_rank() over (partition by t.visit_year, t.visit_month order by t.visit_year, t.visit_month ,t.opsys_count desc) as top_device_opsys,
        t.visit_year,
        t.visit_month
      from (
        select
            coalesce(device_opsys,"unknown") as device_opsys,
            count(distinct fullvisitorid) as opsys_count,
            extract(MONTH from timestamp_seconds(visitStartTime) at Time Zone 'Australia/Sydney') as visit_month,
            extract(YEAR from timestamp_seconds(visitStartTime) at Time Zone 'Australia/Sydney') as visit_year,
            format_date('%b %Y', (date(timestamp_seconds(visitStartTime), 'Australia/Sydney'))) as month_year
    from
    (
/* Start - Datasets of agencies' websites
    Insert Here Google Analytics Dataset of Websites of Interest and 'Union All' query result sets to get final result set
 */
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `122829809.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `6533313.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `73191096.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `103904192.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `37548566.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `39020822.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `121386494.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `114274207.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `121638199.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `149444086.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `122418128.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `135989789.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `162370350.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `178909235.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `5426088.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `6059849.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `106413345.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `117865571.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `117867575.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `53678167.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `77559172.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `77562775.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `80703744.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `100585217.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `111564569.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `124827135.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `174497994.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `179394289.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `72008433.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `77614012.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `86630641.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `69522323.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `70856817.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `71597546.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `77664740.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `129200625.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `82020118.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `88992271.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `98349897.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `100095166.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `100095673.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `74070468.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `133849100.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `175671120.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `175869519.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `48099294.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `78700159.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `94174429.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `94178846.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `100180008.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `100832347.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `104411629.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `34938005.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `77084214.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `85844330.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `86149663.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `90974611.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `95014024.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `118336527.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `130142010.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `170387771.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `99993137.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `80842702.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `199921542.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `23233927.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `2802109.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `70635257.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `73966990.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `191126238.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `203109603.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `47586269.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `5289745.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `93868316.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1 
            union all
    select
              fullvisitorid,
              visitStartTime,
              device.operatingSystem as device_opsys
            from
              `94241432.ga_sessions_*` AS GA,
              UNNEST(GA.hits) AS hits
            where hits.type = 'PAGE'
             and regexp_contains(hits.page.hostname, ".*.gov.au$") = true
             and _table_suffix between FORMAT_DATE('%Y%m%d',DATE_SUB(CURRENT_DATE(), INTERVAL 11 MONTH)) and FORMAT_DATE('%Y%m%d',CURRENT_DATE())
             and totals.visits =1
/* End - Datasets of agencies' websites */
    )
    GROUP BY   
                        device_opsys,
                        visit_year,
                        visit_month,
                        month_year
    ) as t
   ;

   create or replace table dta_project_ursa_major.device_opsys_yearly_snapshot_month_delta_doi
    OPTIONS (
        description = "Monthly delta snapshot of past 12 months",
        expiration_timestamp = TIMESTAMP_ADD(current_timestamp, INTERVAL 1 HOUR)
    )
    as
    select
      device_opsys,
      month_year,
      opsys_count,
      percent_month,
      current_timestamp as post_stamp
      from (
            select 
                  device_opsys,
                  month_year,
                  opsys_count,
                  percent_month,
                  visit_year, visit_month
            from  t_12months_snapshot_opsys_monthlydelta_doi  
            where top_device_opsys < 6
            union all
            select  
                  "Others" as device_opsys,
                  month_year,
                  sum(opsys_count) as opsys_count,
                  round(sum(percent_month),2) as percent_month,
                  visit_year, visit_month
            from  t_12months_snapshot_opsys_monthlydelta_doi
            where top_device_opsys > 5
            group by month_year, visit_year, visit_month
    )
    order by 
          visit_year,
          visit_month,
          opsys_count desc
;
    
END;